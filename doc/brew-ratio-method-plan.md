# 手沖配方倍率換算功能修改計劃書

## 目標

實現「沖煮手法可用倍率（比例）輸入，每段目標水重量隨粉量自動換算」功能。讓用戶只需調整粉量，步驟目標水量即可自動更新，提升沖煮過程的彈性與便利性。

---

## 1. 名詞定義

- **D**：粉量（g）
- **ratio**：粉水比的水倍數（如 15，代表 1:15）
- **W**：總水量（g），計算式：`W = D × ratio`
- **waterEndTargetRatio**：倍率，代表此步驟目標總重 = 粉量 × 此倍率
- **Tn**：第 n 步驟的目標總重
- **Pn**：第 n 步驟實際注水量

---

## 2. 使用者場景 & 需求

- 用戶能夠在「沖煮手法編輯」時，直接用比例輸入每步驟目標（如：2、6、12、15，代表「粉量 × 倍率」）。
- 在實際沖煮時，輸入/調整粉量後，各步驟目標總重都自動依倍率換算，UI 自動即時顯示。
- 舊有「絕對水重」定義的手法（直接填如 40g、120g）需維持兼容。

---

## 3. 計算公式範本

以粉量 D = 20g、粉水比 ratio = 15 為例：

- **總水量 W = 20 × 15 = 300g**
- **悶蒸（T1）：D × 2 = 40g**
- **第一段（T2）：D × 6 = 120g**
- **第二段（T3）：D × 12 = 240g**
- **第三段（T4）：D × 15 = 300g**

（步驟倍率依序為 2 / 6 / 12 / 15）

### 每段注水量

- 悶蒸：D × 2
- 第一段：D × 4
- 第二段：D × 6
- 第三段：D × 3

---

## 4. 資料結構與界面修改重點

### 資料結構調整（TypeScript interface）

- `BrewStep` 增加 `waterEndTargetRatio?: number` 欄位（代表倍率）。
- 舊有 `waterEndTarget`（絕對值，單位 g）保留，舊資料不受影響。
- 系統呈現時：
  - 若有 `waterEndTargetRatio`，顯示為「粉量 × 倍率」自動計算值。
  - 若無，則採用原本絕對值。

### 編輯界面

- 編輯單一步驟時，提供模式切換（倍率/絕對值）或可同時提供欄位（如倍率有值優先採用）。
- 增加說明提示，例如：「填入倍率（例如 2、6、12、15），系統會自動以 '粉量 × 倍率' 計算每步驟目標總重」。
- 防呆處理（倍率需大於 0）。

### 計時器/沖煮畫面

- 用戶一旦調整粉量，各步驟目標總重即時依倍率換算。
- 現有僅顯示絕對值的 Recipe 需保持原樣資源。

### 預設手法範例

- 提供內建一組例子（悶蒸/第一/第二/第三段，倍率依上），方便新手理解。

---

## 5. 文件說明及公式

建議於 README 或 in-app help 加入：

- 「此手法支援用倍率定義步驟目標水重，
  只需調整粉量，即自動換算沖煮各階段目標重量」
- 計算公式展示範例（如上）

---

## 6. 兼容性須知

- 持續支援原本「每步定死水重」手法，讓老用戶可以無痛轉換。
- 新增倍率欄位，若同時有倍率與絕對值，採「倍率」優先。

---

## 7. 測試重點

- 編輯手法時，填入倍率、切換粉量、所有階段水重量會即時正確變動。
- 舊資料（只填絕對水重）不會壞。
- 若同時填入倍率與絕對值，以倍率自動計算為主。
- 邊界狀況：倍率 = 0、不合法值，應有提示不得儲存。

---

## 8. 加值項目（可選）

- （進階）可支援倍率小數點，或用戶自訂每步倍率名（ex: “花式段落”自命名）。
- step name/說明/參考時間預設自動填入，讓新建立更快。

---

## 範例手法區塊（建議可直接複製）

> 以粉量為基準設計各階段水量分配，方便不同杯量沖煮直接變換

- **粉水比 Ratio**：1 : 15
- **目標總重 = 粉量 × 15**
- **分段倍率**：
  - 悶蒸：粉量 × 2
  - 第一段：粉量 × 6
  - 第二段：粉量 × 12
  - 第三段：粉量 × 15
- **公式展示**：
  - 若粉量 18g → 順序為 36g/108g/216g/270g
  - 若粉量 20g → 順序為 40g/120g/240g/300g

---

## 9. 實施流程建議

1. 更新資料結構
2. 編輯畫面加上倍率模式選擇
3. 計算及顯示處理邏輯加倍率優先
4. 加入預設手法模板
5. 補上使用說明文件或 UI 協助
6. 測試新版與舊版手法皆運作良好

---
