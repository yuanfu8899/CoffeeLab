<div class="space-y-6 pb-20">
  <!-- Tab 切換 -->
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold text-amber-500">沖煮紀錄</h2>
    <div class="flex gap-2">
      <button type="button" (click)="activeTab.set('add')"
              [class.bg-amber-500]="activeTab() === 'add'"
              [class.text-slate-900]="activeTab() === 'add'"
              [class.bg-slate-700]="activeTab() !== 'add'"
              [class.text-slate-300]="activeTab() !== 'add'"
              class="px-4 py-2 rounded-lg font-bold transition">
        新增紀錄
      </button>
      <button type="button" (click)="activeTab.set('list'); loadRecords()"
              [class.bg-amber-500]="activeTab() === 'list'"
              [class.text-slate-900]="activeTab() === 'list'"
              [class.bg-slate-700]="activeTab() !== 'list'"
              [class.text-slate-300]="activeTab() !== 'list'"
              class="px-4 py-2 rounded-lg font-bold transition">
        查看紀錄
      </button>
    </div>
  </div>

  <!-- 新增紀錄 Tab -->
  <div *ngIf="activeTab() === 'add'">
    <form (ngSubmit)="submit()" class="space-y-6">
    
    <!-- 1. Selection Section -->
    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 space-y-4">
      <h3 class="text-slate-200 font-semibold mb-2">基本資訊</h3>
      
      <!-- Bean Selector -->
      <div>
        <label class="block text-slate-400 text-sm mb-1">咖啡豆</label>
        <select [(ngModel)]="record.beanId" name="beanId" required
                class="w-full bg-slate-700 text-white rounded p-3 focus:ring-2 focus:ring-amber-500 outline-none">
          <option *ngFor="let b of beans()" [value]="b.id">{{ b.name }} ({{ b.roastLevel }})</option>
        </select>
      </div>

      <!-- Method & Grinder -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-slate-400 text-sm mb-1">沖煮法</label>
          <select [(ngModel)]="record.methodId" name="methodId" required
                  class="w-full bg-slate-700 text-white rounded p-3 focus:ring-2 focus:ring-amber-500 outline-none">
            <option *ngFor="let m of methods()" [value]="m.id">{{ m.name }}</option>
          </select>
        </div>
        <div>
          <label class="block text-slate-400 text-sm mb-1">磨豆機</label>
          <select [(ngModel)]="record.grinderId" name="grinderId" required
                  class="w-full bg-slate-700 text-white rounded p-3 focus:ring-2 focus:ring-amber-500 outline-none">
            <option *ngFor="let g of grinders()" [value]="g.id">{{ g.name }}</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 2. Parameters Section -->
    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 space-y-4">
      <h3 class="text-slate-200 font-semibold mb-2">沖煮參數</h3>
      
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-slate-400 text-sm mb-1">研磨刻度</label>
          <input type="number" [(ngModel)]="record.settingUsed" name="settingUsed" step="0.1" required
                 class="w-full bg-slate-700 text-white rounded p-3 focus:ring-2 focus:ring-amber-500 outline-none">
        </div>
        <div>
          <label class="block text-slate-400 text-sm mb-1">水溫 (°C)</label>
          <input type="number" [(ngModel)]="record.temperature" name="temperature" required
                 class="w-full bg-slate-700 text-white rounded p-3 focus:ring-2 focus:ring-amber-500 outline-none">
        </div>
      </div>

      <div class="grid grid-cols-3 gap-2">
        <div>
          <label class="block text-slate-400 text-xs mb-1">粉重 (g)</label>
          <input type="number" [(ngModel)]="record.beanWeight" name="beanWeight"
                 class="w-full bg-slate-700 text-white rounded p-2 focus:ring-2 focus:ring-amber-500 outline-none">
        </div>
        <div>
          <label class="block text-slate-400 text-xs mb-1">總水量 (g)</label>
          <input type="number" [(ngModel)]="record.waterWeight" name="waterWeight"
                 class="w-full bg-slate-700 text-white rounded p-2 focus:ring-2 focus:ring-amber-500 outline-none">
        </div>
        <div>
          <label class="block text-slate-400 text-xs mb-1">總時間</label>
          <input type="text" [(ngModel)]="record.totalTime" name="totalTime" placeholder="MM:SS"
                 class="w-full bg-slate-700 text-white rounded p-2 focus:ring-2 focus:ring-amber-500 outline-none">
        </div>
      </div>
    </div>

    <!-- 3. Sensory Profile (Explicit Grid Style to avoid TS7053) -->
    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
      <h3 class="text-slate-200 font-semibold mb-4 flex justify-between items-center">
        <span>風味評測 (1-5)</span>
        <span class="text-xs text-slate-400">0.5 分為單位</span>
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        
        <!-- Aroma -->
        <div class="bg-slate-900/30 p-3 rounded-lg border border-slate-700/30 hover:border-amber-500/30 transition">
          <div class="flex justify-between text-sm mb-2">
            <span class="text-slate-300">香氣 (Aroma)</span>
            <span class="font-mono font-bold text-amber-400">{{ sensory.aroma | number:'1.1-1' }}</span>
          </div>
          <input type="range" min="1" max="5" step="0.5" [(ngModel)]="sensory.aroma" name="aroma" 
                 class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-amber-500">
        </div>

        <!-- Acidity -->
        <div class="bg-slate-900/30 p-3 rounded-lg border border-slate-700/30 hover:border-amber-500/30 transition">
          <div class="flex justify-between text-sm mb-2">
            <span class="text-slate-300">酸值 (Acidity)</span>
            <span class="font-mono font-bold text-amber-400">{{ sensory.acidity | number:'1.1-1' }}</span>
          </div>
          <input type="range" min="1" max="5" step="0.5" [(ngModel)]="sensory.acidity" name="acidity" 
                 class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-amber-500">
        </div>

        <!-- Sweetness -->
        <div class="bg-slate-900/30 p-3 rounded-lg border border-slate-700/30 hover:border-amber-500/30 transition">
          <div class="flex justify-between text-sm mb-2">
            <span class="text-slate-300">甜感 (Sweetness)</span>
            <span class="font-mono font-bold text-amber-400">{{ sensory.sweetness | number:'1.1-1' }}</span>
          </div>
          <input type="range" min="1" max="5" step="0.5" [(ngModel)]="sensory.sweetness" name="sweetness" 
                 class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-amber-500">
        </div>

        <!-- Body -->
        <div class="bg-slate-900/30 p-3 rounded-lg border border-slate-700/30 hover:border-amber-500/30 transition">
          <div class="flex justify-between text-sm mb-2">
            <span class="text-slate-300">醇厚 (Body)</span>
            <span class="font-mono font-bold text-amber-400">{{ sensory.body | number:'1.1-1' }}</span>
          </div>
          <input type="range" min="1" max="5" step="0.5" [(ngModel)]="sensory.body" name="body" 
                 class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-amber-500">
        </div>

        <!-- Balance -->
        <div class="bg-slate-900/30 p-3 rounded-lg border border-slate-700/30 hover:border-amber-500/30 transition">
          <div class="flex justify-between text-sm mb-2">
            <span class="text-slate-300">平衡 (Balance)</span>
            <span class="font-mono font-bold text-amber-400">{{ sensory.balance | number:'1.1-1' }}</span>
          </div>
          <input type="range" min="1" max="5" step="0.5" [(ngModel)]="sensory.balance" name="balance" 
                 class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-amber-500">
        </div>

        <!-- Aftertaste -->
        <div class="bg-slate-900/30 p-3 rounded-lg border border-slate-700/30 hover:border-amber-500/30 transition">
          <div class="flex justify-between text-sm mb-2">
            <span class="text-slate-300">餘韻 (Aftertaste)</span>
            <span class="font-mono font-bold text-amber-400">{{ sensory.aftertaste | number:'1.1-1' }}</span>
          </div>
          <input type="range" min="1" max="5" step="0.5" [(ngModel)]="sensory.aftertaste" name="aftertaste" 
                 class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-amber-500">
        </div>
        
        <!-- Overall -->
        <div class="md:col-span-2 bg-slate-900/50 p-4 rounded-lg border border-slate-700/50">
          <div class="flex justify-between text-sm mb-2">
            <span class="text-amber-500 font-bold">整體評價 (Overall)</span>
            <span class="font-mono font-bold text-amber-500 text-lg">{{ sensory.overall | number:'1.1-1' }}</span>
          </div>
          <input type="range" min="1" max="5" step="0.5" [(ngModel)]="sensory.overall" name="overall" 
                 class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-amber-500">
          <div class="flex justify-between text-xs text-slate-500 mt-1">
            <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
          </div>
        </div>

      </div>

      <!-- Notes -->
      <div class="mt-6">
        <label class="block text-slate-400 text-sm mb-1">詳細筆記</label>
        <textarea [(ngModel)]="record.notes" name="notes" rows="3" placeholder="描述風味細節，例如：前段帶有茉莉花香，中段明亮檸檬酸..."
                  class="w-full bg-slate-700 text-white rounded p-3 focus:ring-2 focus:ring-amber-500 outline-none"></textarea>
      </div>
    </div>

    <button type="submit"
            [disabled]="!canSubmit() || syncStatus().lastSyncResult === 'pending'"
            class="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg hover:bg-amber-400 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-amber-500/20">
      <span *ngIf="syncStatus().lastSyncResult === 'pending'">傳送中...</span>
      <span *ngIf="syncStatus().lastSyncResult !== 'pending' && canSubmit()">儲存完整紀錄</span>
      <span *ngIf="!canSubmit()">無法儲存 - 請先設定 API</span>
    </button>

    </form>
  </div>

  <!-- 查看紀錄 Tab -->
  <div *ngIf="activeTab() === 'list'">
    <!-- 篩選器 -->
    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-4 space-y-3">
      <div>
        <input [(ngModel)]="filterText"
               type="text"
               placeholder="搜尋豆子名稱、手法或筆記..."
               class="w-full bg-slate-700 text-white rounded-lg p-3 border border-slate-600 focus:border-amber-500 outline-none">
      </div>
      <div class="flex gap-2">
        <button type="button" (click)="filterDateRange.set('week')"
                [class.bg-amber-500]="filterDateRange() === 'week'"
                [class.text-slate-900]="filterDateRange() === 'week'"
                [class.bg-slate-700]="filterDateRange() !== 'week'"
                [class.text-slate-300]="filterDateRange() !== 'week'"
                class="px-3 py-1 rounded text-sm transition">
          本週
        </button>
        <button type="button" (click)="filterDateRange.set('month')"
                [class.bg-amber-500]="filterDateRange() === 'month'"
                [class.text-slate-900]="filterDateRange() === 'month'"
                [class.bg-slate-700]="filterDateRange() !== 'month'"
                [class.text-slate-300]="filterDateRange() !== 'month'"
                class="px-3 py-1 rounded text-sm transition">
          本月
        </button>
        <button type="button" (click)="filterDateRange.set('all')"
                [class.bg-amber-500]="filterDateRange() === 'all'"
                [class.text-slate-900]="filterDateRange() === 'all'"
                [class.bg-slate-700]="filterDateRange() !== 'all'"
                [class.text-slate-300]="filterDateRange() !== 'all'"
                class="px-3 py-1 rounded text-sm transition">
          全部
        </button>
      </div>
    </div>

    <!-- 載入中 -->
    <div *ngIf="isLoadingRecords()" class="text-center py-12">
      <div class="animate-spin h-8 w-8 border-4 border-amber-500 border-t-transparent rounded-full mx-auto mb-4"></div>
      <p class="text-slate-400">載入紀錄中...</p>
    </div>

    <!-- 紀錄列表 -->
    <div *ngIf="!isLoadingRecords()" class="space-y-3">
      <div *ngFor="let record of filteredRecords()"
           class="bg-slate-800 p-4 rounded-xl border border-slate-700 space-y-2">
        <!-- Header -->
        <div class="flex justify-between items-start">
          <div>
            <h4 class="text-amber-400 font-bold">{{ record.beanName }}</h4>
            <p class="text-slate-400 text-xs">{{ formatDate(record.date) }}</p>
          </div>
          <div class="text-right">
            <div class="text-xl text-amber-500">★ {{ record.sensory.overall }}</div>
          </div>
        </div>

        <!-- Parameters -->
        <div class="grid grid-cols-3 gap-2 text-xs text-slate-400">
          <div>
            <span class="text-slate-500">手法: </span>
            <span class="text-slate-300">{{ getMethodName(record.methodId) }}</span>
          </div>
          <div>
            <span class="text-slate-500">粉量: </span>
            <span class="text-slate-300">{{ record.beanWeight }}g</span>
          </div>
          <div>
            <span class="text-slate-500">水溫: </span>
            <span class="text-slate-300">{{ record.temperature }}°C</span>
          </div>
        </div>

        <!-- Sensory Profile -->
        <div class="flex gap-2 text-xs flex-wrap">
          <span class="bg-slate-700 px-2 py-1 rounded">香氣 {{ record.sensory.aroma }}</span>
          <span class="bg-slate-700 px-2 py-1 rounded">酸值 {{ record.sensory.acidity }}</span>
          <span class="bg-slate-700 px-2 py-1 rounded">甜感 {{ record.sensory.sweetness }}</span>
          <span class="bg-slate-700 px-2 py-1 rounded">醇厚 {{ record.sensory.body }}</span>
        </div>

        <!-- Notes -->
        <p *ngIf="record.notes" class="text-slate-400 text-sm italic">
          "{{ record.notes.length > 80 ? (record.notes | slice:0:80) + '...' : record.notes }}"
        </p>
      </div>

      <!-- Empty state -->
      <div *ngIf="filteredRecords().length === 0 && !isLoadingRecords()"
           class="text-center py-12 text-slate-500">
        <p class="text-lg">沒有找到符合的紀錄</p>
        <p class="text-sm mt-2">試試調整篩選條件</p>
      </div>
    </div>
  </div>
</div>
