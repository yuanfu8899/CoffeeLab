<div class="space-y-8 pb-20">
  <h2 class="text-2xl font-bold text-amber-500 mb-4">設定</h2>

  <!-- 1. Google Sheets Config -->
  <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
    <h3 class="text-lg font-semibold text-slate-200 mb-2">Google Sheets 整合</h3>
    <p class="text-slate-400 text-sm mb-4">
      請部署一個與您的試算表相連的 Google Apps Script 網頁應用程式 (Web App)，並將產生的 URL 貼在下方。
    </p>

    <label class="block text-slate-300 text-sm mb-1 flex justify-between items-center">
      <span>網頁應用程式 URL</span>
      <span *ngIf="!apiUrlSignal()" class="text-[10px] bg-amber-500/20 text-amber-500 px-2 py-0.5 rounded border border-amber-500/30 animate-pulse">
        尚未設定
      </span>
      <span *ngIf="apiUrlSignal()" class="text-[10px] bg-green-500/20 text-green-500 px-2 py-0.5 rounded border border-green-500/30">
        已連結
      </span>
    </label>
    <input type="text" [ngModel]="apiUrlSignal()" (ngModelChange)="apiUrlSignal.set($event)"
           placeholder="請貼上 https://script.google.com/macros/s/..."
           [class.border-amber-500]="!apiUrlSignal()"
           [class.border-slate-700]="apiUrlSignal()"
           class="w-full bg-slate-700 text-white rounded p-3 focus:ring-2 focus:ring-amber-500 outline-none mb-2 border placeholder:text-slate-500 transition-colors">

    <!-- Sync Status Indicator -->
    <div class="mb-4 flex items-center gap-2 text-xs">
      <span *ngIf="!sheetsService.apiUrl()" class="text-slate-500">
        🔌 未設定雲端連結
      </span>
      <span *ngIf="sheetsService.apiUrl() && syncStatus().lastSyncResult === 'success'"
            class="text-green-400 flex items-center gap-1">
        ✓ 上次同步: {{ formatSyncTime(syncStatus().lastSyncTime) }}
      </span>
      <span *ngIf="syncStatus().lastSyncResult === 'pending'"
            class="text-amber-400 flex items-center gap-1">
        <svg class="animate-spin h-3 w-3" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        同步中...
      </span>
      <span *ngIf="syncStatus().lastSyncResult === 'error'"
            class="text-red-400">
        ✕ 同步失敗
      </span>
    </div>

    <div class="flex gap-4">
      <button (click)='clearConfig()' class="flex-1 bg-slate-700 text-slate-300 font-bold py-3 rounded-lg hover:bg-red-900/50 hover:text-red-400 transition">
        解除連結
      </button>
      <button (click)='saveConfig()' class="flex-[2] bg-amber-500 text-slate-900 font-bold py-3 rounded-lg hover:bg-amber-400 transition">
        儲存配置
      </button>
    </div>
  </div>

  <!-- 2. Grinder Management -->
  <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-slate-200">磨豆機管理</h3>
        <button (click)="openAddGrinder()" class="text-xs bg-amber-500 text-slate-900 px-3 py-1 rounded font-bold">
            + 新增設備
        </button>
    </div>

    <div class="space-y-3">
        <div *ngFor="let g of grinders()" class="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg border border-slate-700">
            <div>
                <div class="text-slate-200 font-bold">{{ g.name }}</div>
                <div class="text-xs text-slate-500">
                    範圍: {{ g.minSetting }} - {{ g.maxSetting }} (步進: {{ g.step }})
                </div>
            </div>
            <div class="flex gap-2">
                <button (click)="openEditGrinder(g)" class="text-slate-500 hover:text-amber-500 transition">✎</button>
                <button (click)="deleteGrinder(g.id)" class="text-slate-500 hover:text-red-500 transition">✕</button>
            </div>
        </div>
        <div *ngIf="grinders().length === 0" class="text-center py-4 text-slate-600 text-sm">
            尚未新增磨豆機設備。
        </div>
    </div>
  </div>

  <!-- 3. Onboarding -->
  <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
    <h3 class="text-lg font-semibold text-slate-200 mb-2">新手引導</h3>
    <p class="text-slate-400 text-sm mb-4">
      重新查看應用程式的新手引導流程，了解如何使用咖啡實驗室的各項功能。
    </p>
    <button (click)="resetOnboarding()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-500 transition">
      🎯 重新查看新手引導
    </button>
  </div>

  <!-- 4. About -->
  <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
    <h3 class="text-lg font-semibold text-slate-200 mb-2">關於</h3>
    <p class="text-slate-400 text-sm leading-relaxed">
      咖啡實驗室 (Coffee Lab) v5.2<br>
      專為精準沖煮設計的工具。<br>
      技術棧：Angular & Tailwind CSS & Google Apps Script。
    </p>
  </div>
</div>

<!-- Modal -->
<div *ngIf="isModalOpen()" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
  <div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 shadow-2xl p-6">
    <h3 class="text-xl font-bold text-amber-500 mb-4">{{ isEditing() ? '編輯磨豆機' : '新增磨豆機' }}</h3>
    
    <div class="space-y-4">
      <div>
        <label class="block text-slate-400 text-sm mb-1">設備名稱</label>
        <input [(ngModel)]="form.name" type="text" placeholder="例如: 泰摩 S3" class="w-full bg-slate-800 text-white rounded p-2 border border-slate-700 focus:border-amber-500 outline-none">
      </div>
      
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-slate-400 text-sm mb-1">最小刻度</label>
          <input [(ngModel)]="form.minSetting" type="number" class="w-full bg-slate-800 text-white rounded p-2 border border-slate-700 outline-none">
        </div>
        <div>
          <label class="block text-slate-400 text-sm mb-1">最大刻度</label>
          <input [(ngModel)]="form.maxSetting" type="number" class="w-full bg-slate-800 text-white rounded p-2 border border-slate-700 outline-none">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-slate-400 text-sm mb-1">預設刻度</label>
          <input [(ngModel)]="form.defaultSetting" type="number" step="0.1" class="w-full bg-slate-800 text-white rounded p-2 border border-slate-700 outline-none">
        </div>
        <div>
           <label class="block text-slate-400 text-sm mb-1">步進 (Step)</label>
           <input [(ngModel)]="form.step" type="number" step="0.1" class="w-full bg-slate-800 text-white rounded p-2 border border-slate-700 outline-none">
        </div>
      </div>
    </div>

    <div class="flex gap-4 mt-6">
      <button (click)="isModalOpen.set(false)" class="flex-1 bg-slate-800 text-slate-300 py-2 rounded-lg hover:bg-slate-700">取消</button>
      <button (click)="saveGrinder()" class="flex-1 bg-amber-500 text-slate-900 font-bold py-2 rounded-lg hover:bg-amber-400">儲存</button>
    </div>
  </div>
</div>
