<div class="space-y-6 pb-20">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold text-amber-500">æ²–ç…®æ‰‹æ³•ç·¨è¼¯</h2>
    <div class="flex gap-2">
      <button (click)="importMethod()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-500 transition">
        ğŸ“¥ åŒ¯å…¥æ‰‹æ³•
      </button>
      <button (click)="openAdd()" class="bg-amber-500 text-slate-900 px-4 py-2 rounded-lg font-bold hover:bg-amber-400 transition">
        + æ–°å¢æ‰‹æ³•
      </button>
    </div>
  </div>

  <!-- Methods List -->
  <div class="grid md:grid-cols-2 gap-4">
    <div *ngFor="let m of methods()" class="bg-slate-800 p-5 rounded-xl border border-slate-700 flex flex-col justify-between group h-full">
      <div>
        <div class="flex justify-between items-start mb-2">
          <h3 class="font-bold text-lg text-slate-200">{{ m.name }}</h3>
          <span class="text-xs px-2 py-0.5 rounded-full border border-slate-600 text-slate-400 capitalize">
            {{ m.category }}
          </span>
        </div>
        <p class="text-sm text-slate-400 mb-4 line-clamp-2">{{ m.description }}</p>
        
        <div class="grid grid-cols-3 gap-2 text-center text-xs text-slate-500 bg-slate-900/50 p-2 rounded-lg">
          <div>
            <div class="text-slate-400">æ°´æº«</div>
            <div class="text-amber-500 font-bold">{{ m.recommendedTemp }}Â°C</div>
          </div>
          <div>
            <div class="text-slate-400">ç²‰æ°´æ¯”</div>
            <div class="text-amber-500 font-bold">1:{{ m.recommendedRatio }}</div>
          </div>
          <div>
            <div class="text-slate-400">æ­¥é©Ÿæ•¸</div>
            <div class="text-amber-500 font-bold">{{ m.steps.length }}</div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2 mt-4 pt-4 border-t border-slate-700">
        <button (click)="exportMethod(m)" class="bg-slate-700 text-slate-300 px-3 py-2 rounded text-sm hover:bg-slate-600 transition flex items-center justify-center gap-1">
          <span>ğŸ“¤</span> åŒ¯å‡º
        </button>
        <button (click)="shareMethod(m)" class="bg-amber-500 text-slate-900 px-3 py-2 rounded text-sm font-bold hover:bg-amber-400 transition flex items-center justify-center gap-1">
          <span>ğŸ”—</span> åˆ†äº«
        </button>
        <button (click)="openEdit(m)" class="bg-slate-700 text-slate-300 px-3 py-2 rounded text-sm hover:bg-slate-600 transition flex items-center justify-center gap-1">
          <span>âœï¸</span> ç·¨è¼¯è©³æƒ…
        </button>
        <button (click)="delete(m.id)" class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-500 transition flex items-center justify-center gap-1">
          <span>ğŸ—‘ï¸</span> åˆªé™¤
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div *ngIf="isModalOpen()" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm overflow-y-auto">
  <div class="bg-slate-900 w-full max-w-3xl rounded-2xl border border-slate-700 shadow-2xl p-6 my-8">
    <h3 class="text-xl font-bold text-amber-500 mb-6">{{ isEditing() ? 'ç·¨è¼¯æ‰‹æ³•' : 'æ–°å¢æ‰‹æ³•' }}</h3>

    <div class="space-y-6">
      <!-- åŸºæœ¬è³‡è¨Šå€å¡Š -->
      <div class="space-y-4">
        <h4 class="text-slate-200 font-bold text-sm border-b border-slate-700 pb-2 mb-4">åŸºæœ¬è³‡è¨Š</h4>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-slate-400 text-sm mb-1">åç¨±</label>
            <input [(ngModel)]="form.name" type="text" class="w-full bg-slate-800 text-white rounded p-2 border border-slate-700 focus:border-amber-500 outline-none">
          </div>

          <div>
            <label class="block text-slate-400 text-sm mb-1">é¡åˆ¥</label>
            <select [(ngModel)]="form.category" class="w-full bg-slate-800 text-white rounded p-2 border border-slate-700 outline-none">
              <option value="drip">æ‰‹æ²– (Drip)</option>
              <option value="immersion">æµ¸æ³¡ (Immersion)</option>
              <option value="espresso">ç¾©å¼ (Espresso)</option>
            </select>
          </div>

          <div>
            <label class="block text-slate-400 text-sm mb-1">å»ºè­°æ°´æº«</label>
            <input [(ngModel)]="form.recommendedTemp" type="number" class="w-full bg-slate-800 text-white rounded p-2 border border-slate-700 outline-none">
          </div>

          <div>
            <label class="block text-slate-400 text-sm mb-1">å»ºè­°ç²‰æ°´æ¯” (1:?)</label>
            <input [(ngModel)]="form.recommendedRatio" type="number" class="w-full bg-slate-800 text-white rounded p-2 border border-slate-700 outline-none">
          </div>
        </div>

        <div>
          <label class="block text-slate-400 text-sm mb-1">ç°¡ä»‹</label>
          <textarea [(ngModel)]="form.description" rows="2" class="w-full bg-slate-800 text-white rounded p-2 border border-slate-700 outline-none resize-none"></textarea>
        </div>
      </div>

      <!-- æ­¥é©Ÿè¨­å®šå€å¡Š -->
      <div class="space-y-4">
         <div class="flex justify-between items-center border-b border-slate-700 pb-2">
            <h4 class="text-slate-200 font-bold text-sm">æ­¥é©Ÿè¨­å®š</h4>
            <div class="flex items-center gap-3">
              <!-- è¼¸å…¥æ¨¡å¼åˆ‡æ› -->
              <div class="flex items-center gap-2 bg-slate-800 rounded px-2 py-1">
                <button type="button"
                        (click)="inputMode.set('cumulative')"
                        [class.bg-amber-600]="inputMode() === 'cumulative'"
                        [class.text-slate-900]="inputMode() === 'cumulative'"
                        [class.text-slate-400]="inputMode() !== 'cumulative'"
                        class="px-2 py-0.5 rounded text-xs font-medium transition-colors">
                  Î£ ç´¯ç©
                </button>
                <button type="button"
                        (click)="inputMode.set('incremental')"
                        [class.bg-amber-600]="inputMode() === 'incremental'"
                        [class.text-slate-900]="inputMode() === 'incremental'"
                        [class.text-slate-400]="inputMode() !== 'incremental'"
                        class="px-2 py-0.5 rounded text-xs font-medium transition-colors">
                  Î” å¢é‡
                </button>
              </div>

              <!-- é è¦½ç²‰é‡ -->
              <div class="flex items-center gap-2">
                <label class="text-xs text-slate-400">é è¦½ç²‰é‡ï¼š</label>
                <input [(ngModel)]="previewDose" type="number" min="1" step="1"
                       class="w-16 bg-slate-800 text-white text-sm rounded px-2 py-1 border border-slate-700">
                <span class="text-xs text-slate-400">g</span>
              </div>

              <button (click)="addStep()" class="text-sm bg-amber-600 hover:bg-amber-500 text-slate-900 font-medium px-3 py-1.5 rounded transition-colors">+ æ–°å¢æ­¥é©Ÿ</button>
            </div>
         </div>

         <div class="max-h-[450px] overflow-y-auto space-y-3 pr-2">
            <div *ngFor="let step of tempSteps; let i = index" class="bg-slate-800 p-3 rounded border border-slate-700 relative group">
               <button (click)="removeStep(i)" class="absolute top-1 right-1 text-slate-600 hover:text-red-500 px-2">Ã—</button>

               <div class="grid grid-cols-2 gap-2 mb-2 pr-4">
                  <input [(ngModel)]="step.name" placeholder="æ­¥é©Ÿåç¨±" class="bg-slate-900 text-white text-sm rounded p-1 border border-slate-700 w-full">
                  <select [(ngModel)]="step.type" class="bg-slate-900 text-white text-sm rounded p-1 border border-slate-700 w-full">
                    <option value="pour">æ³¨æ°´</option>
                    <option value="wait">ç­‰å¾…</option>
                  </select>
               </div>

               <div class="grid grid-cols-2 gap-2 mb-2">
                  <div class="flex items-center gap-1">
                    <input [(ngModel)]="step.duration" type="number" min="1" class="bg-slate-900 text-white text-sm rounded p-1 border border-slate-700 w-full">
                    <span class="text-[10px] text-slate-500">ç§’</span>
                  </div>
                  <div></div>
               </div>

               <!-- æ°´é‡è¼¸å…¥ï¼šæŒ‰éˆ•åˆ‡æ›æ¨¡å¼ -->
               <div *ngIf="step.type === 'pour'" class="space-y-2">
                 <!-- æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
                 <div class="flex gap-2">
                   <button type="button"
                           (click)="setStepMode(i, 'ratio')"
                           [class.bg-amber-600]="isRatioMode(step)"
                           [class.bg-slate-700]="!isRatioMode(step)"
                           [class.text-slate-900]="isRatioMode(step)"
                           [class.text-slate-300]="!isRatioMode(step)"
                           class="flex-1 px-3 py-1 rounded text-sm font-medium transition-colors">
                     å€ç‡æ¨¡å¼
                   </button>
                   <button type="button"
                           (click)="setStepMode(i, 'absolute')"
                           [class.bg-amber-600]="!isRatioMode(step)"
                           [class.bg-slate-700]="isRatioMode(step)"
                           [class.text-slate-900]="!isRatioMode(step)"
                           [class.text-slate-300]="isRatioMode(step)"
                           class="flex-1 px-3 py-1 rounded text-sm font-medium transition-colors">
                     çµ•å°å€¼æ¨¡å¼
                   </button>
                 </div>

                 <!-- å€ç‡è¼¸å…¥ï¼šæ ¹æ“š inputMode é¡¯ç¤ºç´¯ç©æˆ–å¢é‡ -->
                 <div *ngIf="isRatioMode(step)">
                   <!-- ç´¯ç©å€ç‡è¼¸å…¥ -->
                   <div *ngIf="inputMode() === 'cumulative'">
                     <div class="grid grid-cols-2 gap-2">
                       <div class="flex items-center gap-1">
                         <span class="text-[10px] text-slate-500 whitespace-nowrap">ç´¯ç© Ã—</span>
                         <input [(ngModel)]="step.waterEndTargetRatio"
                                type="number"
                                step="0.5"
                                min="0"
                                class="flex-1 bg-slate-900 text-white text-sm rounded p-1 border border-slate-700"
                                placeholder="å€ç‡">
                       </div>
                       <!-- å³æ™‚é è¦½ï¼šé¡¯ç¤ºç´¯ç©å’Œå¢é‡ -->
                       <div *ngIf="step.waterEndTargetRatio && step.waterEndTargetRatio > 0" class="flex items-center text-xs text-slate-400 space-x-2">
                         <span>ğŸ’¡ ç´¯ç© {{ (step.waterEndTargetRatio * previewDose()) | number:'1.0-1' }}g</span>
                         <span class="text-amber-400">
                           æœ¬æ®µ +{{ (getIncrementalRatio(i) * previewDose()) | number:'1.0-1' }}g
                         </span>
                       </div>
                     </div>
                   </div>

                   <!-- å¢é‡å€ç‡è¼¸å…¥ -->
                   <div *ngIf="inputMode() === 'incremental'">
                     <div class="grid grid-cols-2 gap-2">
                       <div class="flex items-center gap-1">
                         <span class="text-[10px] text-slate-500 whitespace-nowrap">æœ¬æ®µ Ã—</span>
                         <input [ngModel]="getIncrementalRatio(i)"
                                (ngModelChange)="setIncrementalRatio(i, $event)"
                                type="number"
                                step="0.5"
                                min="0"
                                class="flex-1 bg-slate-900 text-white text-sm rounded p-1 border border-slate-700"
                                placeholder="å€ç‡">
                       </div>
                       <!-- å³æ™‚é è¦½ï¼šé¡¯ç¤ºå¢é‡å’Œç´¯ç© -->
                       <div *ngIf="getIncrementalRatio(i) > 0" class="flex items-center text-xs text-slate-400 space-x-2">
                         <span>ğŸ’¡ æœ¬æ®µ {{ (getIncrementalRatio(i) * previewDose()) | number:'1.0-1' }}g</span>
                         <span class="text-amber-400" *ngIf="step.waterEndTargetRatio">
                           ç´¯ç© {{ (step.waterEndTargetRatio * previewDose()) | number:'1.0-1' }}g
                         </span>
                       </div>
                     </div>
                   </div>
                 </div>

                 <!-- çµ•å°å€¼è¼¸å…¥ -->
                 <div *ngIf="!isRatioMode(step)">
                   <div class="grid grid-cols-2 gap-2">
                     <div class="flex items-center gap-1">
                       <span class="text-[10px] text-slate-500 whitespace-nowrap">ç´¯ç©è‡³</span>
                       <input [(ngModel)]="step.waterEndTarget"
                              type="number"
                              min="0"
                              step="5"
                              class="flex-1 bg-slate-900 text-white text-sm rounded p-1 border border-slate-700"
                              placeholder="ç¸½æ°´é‡">
                       <span class="text-[10px] text-slate-500">g</span>
                     </div>
                     <div></div>
                   </div>
                 </div>
               </div>

               <input [(ngModel)]="step.description" placeholder="æç¤º (å¦‚: ä¸­å¿ƒç¹åœˆ)" class="bg-slate-900 text-slate-400 text-xs rounded p-1 border border-slate-700 w-full">
            </div>

            <div *ngIf="tempSteps.length === 0" class="text-center text-slate-500 text-sm py-8 border-2 border-dashed border-slate-700 rounded-lg">
              é‚„æ²’æœ‰æ­¥é©Ÿï¼Œé»æ“Šä¸Šæ–¹ã€Œ+ æ–°å¢æ­¥é©Ÿã€æŒ‰éˆ•é–‹å§‹å»ºç«‹ã€‚
            </div>
         </div>
      </div>
    </div>

    <div class="flex gap-4 mt-6 pt-4 border-t border-slate-700">
      <button (click)="isModalOpen.set(false)" class="flex-1 bg-slate-800 text-slate-300 py-2 rounded-lg hover:bg-slate-700">å–æ¶ˆ</button>
      <button (click)="save()" class="flex-1 bg-amber-500 text-slate-900 font-bold py-2 rounded-lg hover:bg-amber-400">å„²å­˜è®Šæ›´</button>
    </div>
  </div>
</div>

<!-- Share Modal -->
<div *ngIf="showShareModal()" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
  <div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 shadow-2xl p-6">
    <h3 class="text-xl font-bold text-amber-500 mb-4">åˆ†äº«æ‰‹æ³•</h3>

    <p class="text-slate-400 text-sm mb-2">è¤‡è£½æ­¤é€£çµåˆ†äº«çµ¦æœ‹å‹ï¼š</p>
    <div class="flex gap-2 mb-4">
      <input [value]="shareUrl()"
             readonly
             class="flex-1 bg-slate-800 text-white p-3 rounded-lg border border-slate-700 text-sm">
      <button (click)="copyToClipboard(shareUrl())"
              class="bg-amber-500 text-slate-900 px-4 py-2 rounded-lg font-bold hover:bg-amber-400 transition">
        è¤‡è£½
      </button>
    </div>

    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700 text-xs text-slate-400 mb-4">
      <p class="mb-1">ğŸ’¡ ä½¿ç”¨æ–¹å¼ï¼š</p>
      <ul class="list-disc list-inside space-y-1 ml-2">
        <li>å°‡é€£çµå‚³é€çµ¦æœ‹å‹</li>
        <li>å°æ–¹æ‰“é–‹é€£çµå¾Œæœƒè‡ªå‹•åŒ¯å…¥æ‰‹æ³•</li>
        <li>ä¹Ÿå¯ä»¥é¸æ“‡ä¸‹è¼‰ JSON æª”æ¡ˆåˆ†äº«</li>
      </ul>
    </div>

    <div class="flex justify-end">
      <button (click)="showShareModal.set(false)"
              class="text-slate-400 hover:text-slate-300 px-4 py-2">
        é—œé–‰
      </button>
    </div>
  </div>
</div>